name: Validate Bootstrap and Ensure Baseline

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:
  release:
    types: [published, created]

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure baseline files and folders
        shell: bash
        run: |
          set -euo pipefail
          ensure_dir() { mkdir -p "$1"; }
          ensure_file() { local path="$1"; shift; if [ ! -f "$path" ]; then printf "%s" "$*" > "$path"; echo "Created $path"; fi; }

          # Derive CLIENT and PROJECT
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          CLIENT="Farienergy"
          PROJECT="$REPO_NAME"
          if [ -f ".env.example" ]; then
            C1=$(grep -E '^CLIENT=' .env.example | head -n1 | cut -d= -f2- || true)
            P1=$(grep -E '^PROJECT=' .env.example | head -n1 | cut -d= -f2- || true)
            if [ -n "${C1:-}" ]; then CLIENT="$C1"; fi
            if [ -n "${P1:-}" ]; then PROJECT="$P1"; fi
          fi
          if [ -f "PROYECTO.md" ]; then
            TITLE=$(head -n1 PROYECTO.md || true)
            TP=$(echo "$TITLE" | sed -n 's/^# PROYECTO: \(.*\) (Cliente: .*).*$/\1/p' | sed 's/[[:space:]]*$//' || true)
            TC=$(echo "$TITLE" | sed -n 's/^# PROYECTO: .* (Cliente: \(.*\)).*$/\1/p' | sed 's/[[:space:]]*$//' || true)
            if [ -n "$TP" ]; then PROJECT="$TP"; fi
            if [ -n "$TC" ]; then CLIENT="$TC"; fi
          fi

          # Ensure directories
          ensure_dir context
          ensure_dir context/varios
          ensure_dir propuestas
          ensure_dir Checkpoints
          ensure_dir meta
          ensure_dir meta/plantillas
          ensure_dir scripts
          ensure_dir api
          ensure_dir .continue/assistants

          # Ensure files without overwriting existing ones
          ensure_file ".gitignore" "$(cat <<'EOF' | sed -e 's/^ *//'
            .env
            node_modules/
            dist/
            .DS_Store
            .vscode/
            .idea/
EOF
)"

          ensure_file ".env.example" "$(cat <<-EOF
OPENAI_API_KEY=
ENV=dev
CLIENT=${CLIENT}
PROJECT=${PROJECT}
EOF
)"

          if [ ! -f "PROYECTO.md" ]; then
            cat > PROYECTO.md <<EOF
# PROYECTO: ${PROJECT} (Cliente: ${CLIENT})

## Flujo de estados
- [ ] Pendiente
- [ ] En Progreso
- [ ] Hecho
- [ ] Aprobado

## Backlog inicial
- Bootstrap de estructura y artefactos
- Publicar plantilla en GitHub como repo template y documentar proceso de clonación
EOF
            echo "Created PROYECTO.md"
          fi

          ensure_file "context/00_ARQUITECTURA_PROPUESTA.md" "$(cat <<'EOF'
# Arquitectura Propuesta: Integra Evolucionada

Esta propuesta presenta una arquitectura Integra Evolucionada, centrada en:

- Simplicidad operativa y modularidad.
- Estándares claros de entrega y trazabilidad.
- Capas separadas para dominio, aplicación y plataforma.

Estructura estándar sugerida:
- context/: documentación de arquitectura y decisiones.
- api/: endpoints, contratos y adaptadores.
- scripts/: automatizaciones (bootstrap, tareas rutinarias).
- meta/: plantillas de control y trazabilidad.
- Checkpoints/: hitos y estados del proyecto.
- propuestas/: espacio para alternativas y POCs.

Principios:
- Evolución incremental, cambios pequeños y seguros.
- Observabilidad y checklist de calidad.
- Política fast-path: crear/editar sin pedir confirmación; confirmar solo acciones destructivas.
EOF
)"

          ensure_file "context/dossier_tecnico.md" "$(cat <<'EOF'
# Dossier Técnico

## Decisiones técnicas

## Supuestos

## Riesgos

## Enlaces
EOF
)"

          ensure_file "meta/plantilla_control.md" "tarea:
cambios:
supuestos:
riesgos:
próximos pasos:
"

          if [ ! -f "bootstrap.md" ]; then
            UTC_NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            cat > bootstrap.md <<EOF
Fecha (UTC): ${UTC_NOW}
Cliente: ${CLIENT}
Proyecto: ${PROJECT}
EOF
            echo "Created bootstrap.md"
          fi

          ensure_file "api/.gitkeep" ""
          ensure_file "context/varios/.gitkeep" ""
          ensure_file "propuestas/.gitkeep" ""

          ensure_file ".continue/assistants/aria-arquitecta.json" "$(cat <<'EOF'
{
  "name": "Aria (Arquitecta)",
  "defaultModel": "gpt-5",
  "models": ["gpt-5", "gpt-4o"],
  "provider": "OpenAI",
  "apiKey": "${{ secrets.OPENAI_API_KEY }}",
  "apiBase": "https://api.openai.com/v1",
  "identity": "Arquitecta, Integra Evolucionada, español",
  "rules": [
    "Usar PROYECTO.md como fuente de verdad",
    "Política fast-path: crear/editar sin pedir confirmación; confirmar solo acciones destructivas"
  ],
  "notes": "Si gpt-5 no existe en la API, usar gpt-4o como predeterminado."
}
EOF
)"

          ensure_file ".continue/assistants/ines-ejecutora.json" "$(cat <<'EOF'
{
  "name": "Inés (Ejecutora)",
  "defaultModel": "gpt-4o",
  "models": ["gpt-4o", "gpt-5"],
  "provider": "OpenAI",
  "apiKey": "${{ secrets.OPENAI_API_KEY }}",
  "apiBase": "https://api.openai.com/v1",
  "rules": [
    "Modo ejecutor directo",
    "Producir artefactos y checkpoints sin pedir confirmación"
  ],
  "notes": "Predeterminada gpt-4o; respaldo gpt-5 si está disponible."
}
EOF
)"

          ensure_file ".editorconfig" "$(cat <<'EOF'
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
indent_style = space
indent_size = 2
trim_trailing_whitespace = true

[*.ps1]
end_of_line = crlf
indent_size = 2

[*.md]
max_line_length = off
trim_trailing_whitespace = false
EOF
)"

          ensure_file ".gitattributes" "$(cat <<'EOF'
# Normalize line endings and enforce consistent diffs
* text=auto

# Scripts
*.sh text eol=lf
*.ps1 text eol=crlf

# Markdown and docs
*.md text eol=lf
*.txt text eol=lf

# JSON/YAML
*.json text eol=lf
*.yml  text eol=lf
*.yaml text eol=lf

# Images (binary)
*.png binary
*.jpg binary
*.jpeg binary
*.gif binary
*.svg text eol=lf
EOF
)"

          ensure_file "LICENSE" "$(cat <<'EOF'
MIT License

Copyright (c) 2025 Farienergy

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
EOF
)"

      - name: Create release checkpoint (on release)
        if: github.event_name == 'release'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p Checkpoints
          TS=$(date -u +"%Y-%m-%d_%H%M")
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TAG="${GITHUB_REF_NAME:-${GITHUB_EVENT_RELEASE_TAG_NAME:-}}"
          SHA=$(git rev-parse --short HEAD)
          cat > "Checkpoints/CHK_${TS}.md" <<EOF
# Checkpoint ${TS}

Release publicada.

- Repo: ${GITHUB_REPOSITORY}
- Tag: ${TAG}
- Commit: ${SHA}
- Fecha UTC: ${NOW}
EOF
          echo "Created release checkpoint: Checkpoints/CHK_${TS}.md"

      - name: Commit and push changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --quiet || ! git diff --cached --quiet; then
            git add -A
            git commit -m "ci: ensure bootstrap baseline and checkpoints"
            git push
          else
            echo "No changes to commit."
          fi

name: Validate Bootstrap and Ensure Baseline

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:
  release:
    types: [published, created]

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure baseline files and folders
        shell: bash
        run: scripts/ensure_baseline.sh

      - name: Create release checkpoint (on release)
        if: github.event_name == 'release'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p Checkpoints
          TS=$(date -u +"%Y-%m-%d_%H%M")
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TAG="${GITHUB_REF_NAME:-${GITHUB_EVENT_RELEASE_TAG_NAME:-}}"
          SHA=$(git rev-parse --short HEAD)
          printf '# Checkpoint %s\n\nRelease publicada.\n\n- Repo: %s\n- Tag: %s\n- Commit: %s\n- Fecha UTC: %s\n' \
            "$TS" "${GITHUB_REPOSITORY}" "${TAG}" "${SHA}" "${NOW}" > "Checkpoints/CHK_${TS}.md"
          echo "Created release checkpoint: Checkpoints/CHK_${TS}.md"

      - name: Commit and push changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --quiet || ! git diff --cached --quiet; then
            git add -A
            git commit -m "ci: ensure bootstrap baseline and checkpoints"
            git push
          else
            echo "No changes to commit."
          fi

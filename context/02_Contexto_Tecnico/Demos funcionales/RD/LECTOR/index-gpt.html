<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RD‑AMI · Carga con IA (Formato Universal)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { background:#0a0a0a; color:#f3f4f6; }
    .drop{border:2px dashed #374151;border-radius:1rem;padding:1.25rem;text-align:center;cursor:pointer;transition:all .15s ease}
    .drop.dragover{background:rgba(255,255,255,.05); border-color:#60a5fa}
    .card{border:1px solid #1f2937;border-radius:.75rem;background:rgba(17,24,39,.5);padding:1rem}
    pre{white-space:pre-wrap}
    .err{background:#7f1d1d;border:1px solid #b91c1c;color:#fecaca;padding:.5rem .75rem;border-radius:.5rem;font-size:.8rem;margin-top:.5rem;white-space:pre-wrap}
    .spinner{width:16px;height:16px;border:2px solid #9ca3af;border-top-color:#f3f4f6;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:.5rem}
    @keyframes spin{to {transform:rotate(360deg)}}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
</head>
<body class="min-h-screen w-full px-4 py-8 md:px-10">
  <header class="mb-6">
    <h1 class="text-2xl md:text-3xl font-semibold">RD‑AMI · Carga con IA (Procesador Híbrido Final)</h1>
    <p class="text-sm opacity-80 mt-1">API Key embebida (demo controlado). Todos los resultados con formato estandarizado.</p>
    <div id="api-error" class="err" style="display:none"></div>
  </header>

  <main>
    <section class="card mb-6">
      <div id="drop" class="drop">Suelte sus archivos aquí o haga clic para seleccionar<br/><span class="text-xs opacity-60">PDF o imágenes (JPG/PNG). Múltiples permitidos.</span></div>
      <input id="file" type="file" class="hidden" accept="application/pdf,image/*" multiple />
    </section>

    <section id="list" class="grid gap-4"></section>
  </main>

  <footer class="mt-10 text-xs opacity-60">
    * PDF con texto: extracción de texto + IA.<br/>
    * PDF de imagen (escaneado): conversión a imagen + OCR con IA.<br/>
    * Imagen RX: análisis técnico <u>no diagnóstico</u> con formato estandarizado.
  </footer>

<script>
(() => {
  const pdfjs = window.pdfjsLib;
  const list = document.querySelector("#list");
  const apiErr = document.querySelector("#api-error");
  const zone = document.getElementById("drop");
  const input = document.getElementById("file");

  const API_KEY = window.RD_AMI_OPENAI_KEY || "";
  const MODEL = "gpt-4o-mini";

  // --- FUNCIONES AUXILIARES ---
  async function convertPdfPageToImage(file, pageNumber = 1) {
    try {
      const buf = await file.arrayBuffer();
      const loadingTask = pdfjs.getDocument({ data: buf });
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(pageNumber);
      
      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({ canvasContext: context, viewport: viewport }).promise;

      return canvas.toDataURL("image/jpeg");
    } catch (e) {
      console.error("Error converting PDF to image:", e);
      return null;
    }
  }

  async function fileToDataURL(file){
    return await new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result);r.onerror=reject;r.readAsDataURL(file);});
  }

  // UX helpers
  function showProcessingCard(filename, tipo){
    const id = "card-" + Math.random().toString(36).slice(2);
    const div = document.createElement("div");
    div.className = "card";
    div.id = id;
    div.dataset.filename = filename;
    div.innerHTML = `<div class="flex items-center gap-2 text-sm font-semibold"><span>${filename}</span></div>
      <div class="text-xs opacity-70 mb-2">Estudio: ${tipo || "Detectando..."}</div>
      <div class="text-xs"><span class="spinner"></span>Procesando con IA…</div>`;
    list.prepend(div);
    return id;
  }
  function updateCard(id, tipo, texto, thumbnailUrl){
    const div = document.getElementById(id);
    if (!div) return;
    const filename = div.dataset.filename || "";

    const thumbnailHtml = thumbnailUrl 
      ? `<div class="w-1/3 pl-4 flex-shrink-0"><img src="${thumbnailUrl}" alt="Miniatura" class="rounded-md border border-gray-700 max-h-48 w-full object-contain"></div>`
      : '';

    div.innerHTML = `<div class="text-sm font-semibold">${filename}</div>
      <div class="text-xs opacity-70 mb-2">Estudio: ${tipo}</div>
      <div class="flex">
        <div class="w-2/3 flex-grow"><pre class="text-xs leading-5 bg-neutral-950/60 border border-neutral-800 rounded p-3">${texto}</pre></div>
        ${thumbnailHtml}
      </div>`;
  }
  function errorCard(id, msg){
    const div = document.getElementById(id);
    if (!div) return;
    div.innerHTML = `<div class="text-sm font-semibold">Error</div>
      <pre class="text-xs leading-5 bg-red-950/60 border border-red-700 rounded p-3">${msg}</pre>`;
  }

  // DnD
  zone.addEventListener("click", () => input.click());
  zone.addEventListener("dragover", e => { e.preventDefault(); e.stopPropagation(); zone.classList.add("dragover"); });
  zone.addEventListener("dragleave", e => { e.preventDefault(); e.stopPropagation(); zone.classList.remove("dragover"); });
  zone.addEventListener("drop", e => {
    e.preventDefault(); e.stopPropagation(); zone.classList.remove("dragover");
    const files = Array.from(e.dataTransfer?.files || []);
    if (files.length) processFiles(files);
  });
  input.addEventListener("change", e => {
    const files = Array.from(input.files || []);
    input.value = "";
    if (files.length) processFiles(files);
  });

  // Parsing
  async function extractPdfText(file){
    const buf = await file.arrayBuffer();
    const loadingTask = pdfjs.getDocument({ data: buf });
    const pdf = await loadingTask.promise;
    let text = "";
    for (let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it => it.str).join(" ") + "\n";
    }
    return text;
  }
  
  function detectTipo(text){
    const t = text.toLowerCase();
    if (/(examen medico)/.test(t)) return "Examen Médico";
    if (/(biometria hematica)/.test(t)) return "Biometría Hemática";
    if (/(quimica sanguinea)/.test(t)) return "Química Sanguínea";
    if (/(examen general de orina)/.test(t)) return "Examen General de Orina";
    if (/(audiometr[ií]a)/.test(t)) return "Audiometría";
    if (/(espirometr[ií]a)/.test(t)) return "Espirometría";
    if (/(electrocardiograma|ecg)/.test(t)) return "Electrocardiograma";
    if (/(campimetr[ií]a|examen visual)/.test(t)) return "Campimetría";
    if (/(riesgo cardiovascular)/.test(t)) return "Riesgo Cardiovascular";
    return "Desconocido";
  }


  // --- LLAMADAS A OPENAI ---
  
  async function callOpenAI_Text({ texto, tipo }){
    const sys = `Eres un asistente clínico. Extrae los datos del texto en el formato solicitado.
Devuelve SOLO TEXTO PLANO con este formato:
MATRIZ DE DATOS:
- Campo: Valor
INTERPRETACION:
- Redacta 2–4 líneas específicas para el estudio (${tipo}).`;
    const body = { model: MODEL, messages: [{ role: "system", content: sys },{ role: "user", content: texto }], temperature: 0 };
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST", headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY }, body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error("OpenAI " + res.status);
    return (await res.json())?.choices?.[0]?.message?.content || "";
  }

  async function callOpenAI_VisionOCR({ dataUrl, tipo }){
    const sys = `Eres un asistente clínico de OCR. Analiza la imagen del documento (${tipo}) y extrae la información.
Devuelve SOLO TEXTO PLANO con este formato:
MATRIZ DE DATOS:
- Campo: Valor
INTERPRETACION:
- Redacta 2–4 líneas resumiendo los hallazgos.`;
    const body = {
      model: MODEL,
      messages: [ { role: "system", content: sys }, { role: "user", content: [{ type:"text", text:`Extrae los datos de este estudio de ${tipo}.` }, { type:"image_url", image_url: { url: dataUrl } }] }],
      temperature: 0, max_tokens: 1000,
    };
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST", headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY }, body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error("OpenAI " + res.status);
    return (await res.json())?.choices?.[0]?.message?.content || "";
  }

  async function callOpenAI_VisionNoDx({ dataUrl }){
    const sys = `Eres un asistente de apoyo radiológico.
Devuelve SOLO TEXTO PLANO con este formato exacto:

MATRIZ DE DATOS:
- Proyección: (AP, Lateral, etc.)
- Región Anatómica: (Columna Lumbar, Tórax, etc.)
- Calidad de Imagen: (Adecuada, subóptima, etc.)
- Artefactos: (Presencia o ausencia)

INTERPRETACION:
- Redacta 2-4 líneas con una descripción técnica de los hallazgos. PROHIBIDO dar diagnósticos clínicos. Enfócate en alineación, estructuras visibles y hallazgos técnicos.`;
    const body = {
      model: MODEL, messages: [{ role: "system", content: sys }, { role: "user", content: [{ type:"text", text:"Radiografía para descripción técnica NO DIAGNÓSTICA" }, { type:"image_url", image_url: { url: dataUrl } }] }], temperature: 0
    };
    const res = await fetch("https://api.openai.com/v1/chat/completions", { method: "POST", headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY }, body: JSON.stringify(body) });
    if (!res.ok) throw new Error("OpenAI " + res.status);
    return (await res.json())?.choices?.[0]?.message?.content || "";
  }

  // --- FUNCIÓN DE PROCESAMIENTO PRINCIPAL (HÍBRIDA UNIVERSAL) ---
  async function processFiles(files){
    for (const f of files){
      const tempId = showProcessingCard(f.name, "Detectando…");
      try {
        if (f.type === "application/pdf") {
          const thumbPromise = convertPdfPageToImage(f);
          let text = "";
          try { text = await extractPdfText(f); } catch(e){ errorCard(tempId, "No se pudo leer PDF: " + (e?.message||e)); continue; }
          
          const tipo = detectTipo(text);
          let out = "";
          
          if (text.trim().length < 250) {
            updateCard(tempId, tipo, "PDF sin texto detectable. Analizando como imagen (OCR)...");
            const dataUrl = await thumbPromise;
            out = await callOpenAI_VisionOCR({ dataUrl, tipo });
            updateCard(tempId, tipo + " (Imagen/OCR)", out, dataUrl);
          } else {
            out = await callOpenAI_Text({ texto: text, tipo });
            const thumbnailUrl = await thumbPromise;
            updateCard(tempId, tipo, out, thumbnailUrl);
          }

        } else if (f.type.startsWith("image/")) {
            const dataUrl = await fileToDataURL(f);
            const out = await callOpenAI_VisionNoDx({ dataUrl });
            updateCard(tempId, "Radiografía (imagen)", out, dataUrl);

        } else {
          errorCard(tempId, "Tipo de archivo no soportado en este demo.");
        }
        apiErr.style.display = "none";
      } catch(e){
        apiErr.style.display = "block";
        apiErr.textContent = String(e?.message||e);
        errorCard(tempId, "Error en procesamiento.");
      }
    }
  }
})();
</script>
</body>
</html>
